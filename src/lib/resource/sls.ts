import * as core from '@serverless-devs/core';
import { genComponentInputs } from '../component';
import { AlicloudClient } from './client';

export interface LogConfig {
  project: string;
  logstore: string;
}


export class AlicloudSls extends AlicloudClient {
  genSlsComponentProp(logproject: string, logstore: string, description?: string): any {
    return {
      project: logproject,
      description,
      logstore,
      regionId: this.serverlessProfile.region,
    };
  }

  async createDefaultSls(): Promise<any> {
    const defaultProject = `aliyun-fc-deploy-component-generated-project-${this.serverlessProfile.region}`;
    const defaultLogstore = 'function-log';
    this.logger.info('using \'logConfig: auto\'. FC-DEPLOY will generate default sls project.');
    this.logger.info(`project: ${defaultProject}, logstore: ${defaultLogstore}`);

    const slsComponentIns = await core.load('alibaba/alicloud-sls');
    const slsComponentProp = this.genSlsComponentProp(defaultProject, defaultLogstore, 'Generated by alibaba fc-deploy component');
    const slsComponentInputs = genComponentInputs(this.serverlessProfile.credentials, `${this.serverlessProfile.projectName}-sls-project`, this.serverlessProfile.accessAlias, 'sls', slsComponentProp);
    return await slsComponentIns.create(slsComponentInputs);
  }
}

export function genSlsComponentProp(region: string, logproject: string, logstore: string, description?: string): any {
  const prop = Object.assign({}, {
    Properties: {
      project: logproject,
      description,
      logstore,
      regionId: region,
    },
  });
  return prop;
}
